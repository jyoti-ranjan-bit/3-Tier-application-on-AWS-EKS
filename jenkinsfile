pipeline {
    agent any;
    
    environment{
        SONAR_HOME = tool "Sonar"
    }
    parameters{
        string(name: 'IMAGE_VERSION',defaultValue: 'latest',description: "Image tag")
    }
    stages {
        stage("Code Clone") {
            steps {
                git url: "https://github.com/jyoti-ranjan-bit/Springboot-BankApp/tree/DevOps", branch: "DevOps"
            }
        }
        stage("Trivy File System Scan"){
            steps{
                sh "trivy fs ."
            }
        }
       
        stage("Build") {
            steps {
                sh "docker build -t bankapp-eks:${params.IMAGE_VERSION} ."
            }
        }

        stage("Push") {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: "dockerHub",
                        usernameVariable: "dockerHubUser",
                        passwordVariable: "dockerHubPass"
                    )
                ]) {
                    sh "docker login -u ${dockerHubUser} -p ${dockerHubPass}"
                    sh "docker image tag bankapp-eks:${params.IMAGE_VERSION} ${dockerHubUser}/bankapp-eks:${params.IMAGE_VERSION}"
                    sh "docker push ${dockerHubUser}/bankapp-eks:${params.IMAGE_VERSION}"
                }
            }
        }
    }
}